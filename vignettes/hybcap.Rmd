---
title: "Example: hybcap"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example: hybcap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```



## Introduction


This vignette will demonstrate how to use the `mdlvalr` package functions to generate a concordance analysis of data generated by the hybrid capture pipeline.



Load required packages.

```{r, warning = FALSE, message = FALSE}
library(mdlvalr)
library(tidyverse)
library(glue)
library(openxlsx)
library(plyranges)
```


## Get input data. Use the provided example data that comes with the `mdlvalr` R package. 

Load example data objects


```{r}
# Assign package lazy data object to a env variable
cds_table <- refseq_gff_unnest_with_chrom_cds
```

Get the path to package extra data dir.

```{r}
extdata_dir <- system.file("extdata", package = "mdlvalr", mustWork = TRUE)
```

Find the real file paths of variant and coverage files.


```{r}
var_100ug <- Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-100_*_filtered_integrated_variant_output_summary.xlsx"))
var_150ug <- Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-150_*_filtered_integrated_variant_output_summary.xlsx"))
cov_100ug <- Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-100_*_coverage_summary.xlsx"))
cov_150ug <- Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-150_*_coverage_summary.xlsx"))
```


Create a sample sheet of comparisons


```{r}
sample_sheet <- tibble::tibble(
    var_path_1 = Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-100_*_filtered_integrated_variant_output_summary.xlsx")),
    var_path_2 = Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-150_*_filtered_integrated_variant_output_summary.xlsx")),
    cov_path_1 = Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-100_*_coverage_summary.xlsx")),
    cov_path_2 = Sys.glob(glue("{extdata_dir}/hybcap_v1.0/*-150_*_coverage_summary.xlsx"))
) %>%
    dplyr::mutate(comparison_name_1 = str_remove(basename(var_path_1), "_.*$")) %>%
    dplyr::mutate(comparison_name_2 = str_remove(basename(var_path_2), "_.*$")) %>%
    dplyr::mutate(comparison_name = glue("{comparison_name_1}_vs_{comparison_name_2}"))
```






## Run concordance

```{r}
mdlvalr_list <- get_data(sample_sheet, pipeline = "hybcap")

mdlvalr_list <- add_flags(
    mdlvalr_list,
    cds_table = cds_table,
    var_pass_fail_logic = "VAF >= 0.05",
    cov_pass_fail_logic = "fraction_125x >= 0.9"
)

mdlvalr_list <- compare_vars(mdlvalr_list)
mdlvalr_list <- add_var_labels(mdlvalr_list)
mdlvalr_list <- filter_data(mdlvalr_list)
mdlvalr_list <- get_stats(mdlvalr_list)
```




## Create output files


```{r}
export_excel(mdlvalr_list, filename_prefix = "vaf_0.05_")
```





## Explore the `mdlvalr_list` object

View the list object

```{r}
# Show the list-of-lists object
glimpse(mdlvalr_list)
```



Print the summary stats table

```{r}
mdlvalr_list$summary %>%
    print(width = Inf, n = 6)
```

Names of the filtered table outputs for the first comparison

```{r}
names(mdlvalr_list$comparisons[[1]]$filtered_data)
```


